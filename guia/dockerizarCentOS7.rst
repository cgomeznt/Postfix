Dockerizar Postfix CentOS7
========================

Vamos a crear una imagen de Docker como base con Centos 7.

Primero buscamos las imagenes disponibles::

	docker search centos

Hacemos selección de una imagen y la descargamos::

	docker pull centos:7

Consultamos todas las imagenes que tengamos en local::

	docker images

Verificamos que no tengamos un contenedor con postfix::

	docker ps

Si existe un contenedor con postfix lo detenemos y lo eliminamos::

	docker stop postfix1.0 && docker rm postfix1.0

Consultamos si existe algún otro contenedor y que no este iniciado::

	docker ps -f "status=exited"

Si existiera lo eliminamos::

	docker rm postfix1.0

Ahora que ya tenemos la imagen base de centos 7 en nuestro local, procedemos a crear el contenedor que utilizaremos para postfix::

	docker run -dti --name "postfix1.0"  \
	 -p 25:25 \
	 --privileged "centos:7" /usr/sbin/init

Instalar algunos tools requeridos::

	yum install -y net-tools bind-utils telnet rsyslog.x86_64

Si no tenemos logs pues no sirve, habilitamos el deamo rsyslog::

	systemctl start rsyslog systemctl start rsyslog

Instalar Postfix::

	# yum install postfix mailx cyrus-sasl-plain

Verificamos nuestro archivo hosts::

	# cat /etc/hosts
		127.0.0.1	localhost
		::1	localhost ip6-localhost ip6-loopback
		fe00::0	ip6-localnet
		ff00::0	ip6-mcastprefix
		ff02::1	ip6-allnodes
		ff02::2	ip6-allrouters
		172.17.0.2	5d8fa952e400.e-deus.cf 5d8fa952e400 e-deus.cf

	# cat /etc/resolv.conf 
		# Generated by NetworkManager
		search cantv.net
		nameserver 200.44.32.12
		nameserver 200.109.78.12

Consultamos desde el contenedor de docker con postfix que pueda resolver los nombres de DNS::

	# dig e-deus.cf +short         
	190.198.55.89
	# dig e-deus.cf MX +short
	10 mail.e-deus.cf.
	# dig mail.e-deus.cf. +short
	190.198.55.89


La IP 172.17.0.2  es la asignada a la única interfaz del servidor y la IP 190.198.55.89 es la WAN asociada al dominio e-deus.cf, es decir, previo tienes configurado un DNS Publico.


Configurar Postfix, editamos el archivo /etc/postfix/main.cf::

	# vi /etc/postfix/main.cf
		...
		myhostname = smtp.e-deus.cf
		...
		mydomain = e-deus.cf
		...
		myorigin = $mydomain
		...
		inet_interfaces = all
		...
		inet_protocols = all
		...
		mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
		...
		mynetworks = $config_directory/mynetworks
		...
		home_mailbox = Maildir/
		...
Activamos las ip que estarán autorizadas a usar el smtp para envió. creamos el archivo /etc/postfix/mynetworks::

	# vi /etc/postfix/mynetworks
		# localhost
		127.0.0.0/8

		#LAN
		192.168.1.0/24
		#e-deus.cf
		190.198.55.89


Agregamos nuestra ip a access::

	# vi /etc/postfix/access
		192.168.1.100    OK

Activamos el cambio del archivo access, en realidad crea un archivo access.db::

	# postmap /etc/postfix/access
	
No es necesario, lo dejamos aqui por si se requiere actualizar los alias, esto si editamos en el archivo main.cf alias_maps = hash:/etc/aliases, o si no existe el /etc/aliases::

	newaliases

Montamos el log de background::
	
	tail -f /var/log/maillog &

Habilitamos el servicio del postfix y lo iniciamos::

	# systemctl start postfix
	# systemctl status postfix 

Realizamo un test de envio local::

	# useradd postfixtester
	# passwd postfixtester

Hacemos el test con telnet::

	# telnet localhost smtp
	Trying 127.0.0.1...
	Connected to localhost.
	Escape character is '^]'.
	220 mail.e-deus.cf ESMTP Postfix
	Mar 30 23:34:58 5d8fa952e400 postfix/smtpd[490]: connect from localhost[127.0.0.1]
	ehlo yoserver
	250-mail.e-deus.cf
	250-PIPELINING
	250-SIZE 10240000
	250-VRFY
	250-ETRN
	250-ENHANCEDSTATUSCODES
	250-8BITMIME
	250 DSN
	mail from:carlos.gomez
	250 2.1.0 Ok
	rcpt to:postfixtester
	250 2.1.5 Ok
	Mar 30 23:35:25 5d8fa952e400 postfix/smtpd[490]: 072098A1412: client=localhost[127.0.0.1]
	data
	354 End data with <CR><LF>.<CR><LF>
	Hola
	Esto es una prueba del funcionamiento del postfix
	.
	quit
	221 2.0.0 Bye
	Connection closed by foreign host.


En el log veremos algo como esto::

	250 2.0.0 Ok: queued as 072098A1412
	Mar 30 23:35:47 5d8fa952e400 postfix/cleanup[493]: 072098A1412: message-id=<20210330233525.072098A1412@mail.e-deus.cf>
	Mar 30 23:35:47 5d8fa952e400 postfix/qmgr[476]: 072098A1412: from=<carlos.gomez@e-deus.cf>, size=357, nrcpt=1 (queue active)
	Mar 30 23:35:47 5d8fa952e400 postfix/local[494]: 072098A1412: to=<postfixtester@e-deus.cf>, orig_to=<postfixtester>, relay=local, delay=34, delays=34/0.01/0/0.04, dsn=2.0.0, status=sent (delivered to maildir)
	Mar 30 23:35:47 5d8fa952e400 postfix/qmgr[476]: 072098A1412: removed

Teniendo instalado mailx, esta es otra forma rápida de hacerlo::

	# ls -la / | mail -s"prueba de envio" postfixtester

Ahora para ver los e-mail enviados nos vamos al homedirectory del usuario::

	# ls /home/postfixtester/Maildir/new/
	1617147347.V31I8c1f43M125175.5d8fa952e400  1617147556.V31I8c1f46M488468.5d8fa952e400

Leemos el contenido de unos de los emails::

	# cat /home/postfixtester/Maildir/new/1617147347.V31I8c1f43M125175.5d8fa952e400
	Return-Path: <carlos.gomez@e-deus.cf>
	X-Original-To: postfixtester
	Delivered-To: postfixtester@e-deus.cf
	Received: from yoserver (localhost [127.0.0.1])
		by mail.e-deus.cf (Postfix) with ESMTP id 072098A1412
		for <postfixtester>; Tue, 30 Mar 2021 23:35:13 +0000 (UTC)
	Message-Id: <20210330233525.072098A1412@mail.e-deus.cf>
	Date: Tue, 30 Mar 2021 23:35:13 +0000 (UTC)
	From: carlos.gomez@e-deus.cf

	Hola
	Esto es una prueba del funcionamiento del postfix

Hasta aquí llegue por problemas de enrutamiento de mi moden ABA, no pude certificar el envio a dominios externo y mucho menos recibir de dominios externos.


Para hacer las pruebas a los dominios externos, hacer lo mismo y colocar la rutas validas, ejemplo, cgomez@gmail, cgomez@yahoo.

No olvidemos que para que pueda ser aceptado por los dominios externos el envio de email, debemos cumplir con las convenciones de correo, como tener un DNS el A y su PTR, tener un SPF, no estar en listas negras, etc...etc.
 /var/spool/mail/user or /var/mail/user
